<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H2TechService Business Pro 2026</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --h2-blue: #004085; --h2-light: #007bff; --h2-dark: #2c3e50; }
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; font-size: 10px; margin: 0; display: flex; }
        
        /* Seitliches Men√º */
        .sidebar { 
            width: 160px; 
            background: var(--h2-dark); 
            height: 100vh; 
            position: fixed; 
            left: 0; 
            top: 0; 
            display: flex; 
            flex-direction: column; 
            padding: 15px 10px; 
            gap: 8px; 
            z-index: 1000;
        }
        .sidebar button { 
            font-size: 9px; 
            text-align: left; 
            padding: 8px; 
            border-radius: 5px; 
            border: none; 
            width: 100%; 
            color: white;
            transition: 0.2s;
        }
        .sidebar .btn-success { background: #27ae60 !important; }
        .sidebar .btn-info { background: #2980b9 !important; }
        .sidebar .sidebar .btn-warning { background: #f39c12 !important; color: black; }
        .sidebar .btn-dark { background: #34495e !important; border: 1px solid #555; }
        .sidebar .btn-danger { background: #c0392b !important; }

        /* Hauptbereich */
        .main-wrapper { margin-left: 160px; flex-grow: 1; padding: 10px; display: flex; justify-content: center; }
        .invoice-box { width: 210mm; min-height: 296mm; background: white; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .header-bar { background: linear-gradient(135deg, var(--h2-blue), var(--h2-light)); color: white; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; }
        .content { padding: 30px; flex-grow: 1; display: flex; flex-direction: column; }
        .section-title { font-size: 9px; font-weight: bold; color: var(--h2-light); border-bottom: 2px solid #f0f0f0; margin-bottom: 8px; text-transform: uppercase; }
        .address-data { line-height: 1.5; margin-bottom: 20px; font-size: 10.5px; }
        .payment-box { background: #f8f9fa; border-left: 5px solid var(--h2-blue); padding: 12px; border-radius: 5px; font-size: 11px; }
        .totals-box { background: var(--h2-dark); color: white; padding: 12px; border-radius: 8px; }

        @media print { 
            .sidebar, .no-print { display: none !important; } 
            .main-wrapper { margin-left: 0; padding: 0; } 
            .invoice-box { box-shadow: none; border: none; width: 100%; height: 100%; } 
        }
    </style>
</head>
<body>

    <div class="sidebar no-print shadow">
        <div class="text-white text-center mb-3 border-bottom pb-2">
            <strong style="font-size: 11px;">H2-ERP 2026</strong>
        </div>
        <button onclick="saveInvoice()" class="btn-success">üíæ Speichern</button>
        <button onclick="openCustomerModal()" class="btn-info text-white">üë• Kunden</button>
        <button onclick="openScanner()" class="btn-warning">üì∏ Beleg Scan</button>
        <button onclick="showStats()" class="btn-dark">üìä Bilanz & Steuer</button>
        <button onclick="window.print()" class="btn btn-secondary btn-sm" style="background:#7f8c8d">üñ®Ô∏è Drucken</button>
        <button onclick="downloadPDF()" class="btn-danger">üìÑ PDF Export</button>
        <div class="mt-auto">
            <button onclick="share('whatsapp')" class="btn btn-outline-success btn-sm w-100 mb-1" style="font-size: 8px;">üü¢ WhatsApp</button>
            <button onclick="share('telegram')" class="btn btn-outline-info btn-sm w-100" style="font-size: 8px;">üîµ Telegram</button>
        </div>
    </div>

    <div class="main-wrapper">
        <div id="pdf-area">
            <div class="invoice-box">
                <div class="header-bar">
                    <div><h2 class="m-0">H2TechService</h2><small>Inhaber Osman Tuncer</small></div>
                    <h1 class="m-0" style="letter-spacing: 5px; font-weight: 800;">RECHNUNG</h1>
                </div>
                
                <div class="content">
                    <div class="row">
                        <div class="col-6">
                            <div class="section-title">Absender</div>
                            <div class="address-data">
                                <strong style="font-size: 12px; color: var(--h2-blue); display: block; margin-bottom: 3px;">H2TechService</strong>
                                <span>Suntalstra√üe 48</span><br>
                                <span>31552 Rodenberg</span><br>
                                <span>üìß 74star@gmail.com</span><br>
                                <span>üìû +49 176 66658777</span><br>
                                <span>Steuer-ID: 41/320/887966</span>
                            </div>
                        </div>
                        <div class="col-6 text-end">
                            <div class="mb-3"><b>Nr:</b> <span id="inv-nr" contenteditable="true">H2-2026-001</span><br><b>Datum:</b> <span id="inv-date"></span></div>
                            <div class="section-title">Empf√§nger</div>
                            <div id="cust-display" class="address-data fw-bold text-primary">
                                <span>(Kunde w√§hlen...)</span>
                            </div>
                        </div>
                    </div>

                    <table class="table table-sm border mt-4">
                        <thead>
                            <tr class="table-light">
                                <th>Leistungsbeschreibung</th>
                                <th class="text-center" style="width:50px;">Stk</th>
                                <th class="text-end" style="width:80px;">Einzel (‚Ç¨)</th>
                                <th class="text-center" style="width:60px;">MwSt %</th>
                                <th class="text-end" style="width:90px;">Gesamt (‚Ç¨)</th>
                                <th class="no-print"></th>
                            </tr>
                        </thead>
                        <tbody id="inv-items"></tbody>
                    </table>
                    <button onclick="addRow()" class="btn btn-xs btn-outline-primary no-print">+ Position</button>

                    <div class="row mt-auto pt-4 border-top">
                        <div class="col-7">
                            <div class="payment-box">
                                <strong>Bankverbindung Osman Tuncer</strong><br>
                                <span>IBAN: <b>LT78 3250 0925 1892 8659</b></span><br>
                                <span>BIC: <b>REVOLT21</b></span>
                            </div>
                        </div>
                        <div class="col-5">
                            <div class="totals-box">
                                <div class="d-flex justify-content-between"><span>Netto:</span><span id="sum-n">0,00 ‚Ç¨</span></div>
                                <div class="d-flex justify-content-between small opacity-75"><span>MwSt gesamt:</span><span id="sum-t">0,00 ‚Ç¨</span></div>
                                <hr class="my-1">
                                <div class="d-flex justify-content-between fw-bold" style="font-size: 1.2em;"><span>GESAMT:</span><span id="sum-g">0,00 ‚Ç¨</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-stats" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header bg-dark text-white"><h6>üìä Bilanz & Steuer-√úbersicht</h6><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center">
            <div class="row g-2 mb-3">
                <div class="col-3"><div class="card p-2 bg-success text-white small">Brutto<br><b id="st-brutto">0‚Ç¨</b></div></div>
                <div class="col-3"><div class="card p-2 bg-info text-white small">MwSt-Pool<br><b id="st-steuer">0‚Ç¨</b></div></div>
                <div class="col-3"><div class="card p-2 bg-danger text-white small">Ausgaben<br><b id="st-ausg">0‚Ç¨</b></div></div>
                <div class="col-3"><div class="card p-2 bg-primary text-white small">Gewinn<br><b id="st-gewinn">0‚Ç¨</b></div></div>
            </div>
            <button onclick="exportToCSV()" class="btn btn-success btn-sm w-100 mb-3">üìó Excel/CSV Export</button>
            <table class="table table-sm x-small text-start"><thead><tr><th>Typ</th><th>Info</th><th>MwSt</th><th>Betrag</th><th>Aktionen</th></tr></thead><tbody id="stat-table"></tbody></table>
        </div>
    </div></div></div>

    <div class="modal fade" id="modal-cust" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h6>Kundenverwaltung</h6><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <input type="text" id="c-name" class="form-control mb-1" placeholder="Name">
            <input type="text" id="c-street" class="form-control mb-1" placeholder="Stra√üe">
            <input type="text" id="c-city" class="form-control mb-1" placeholder="PLZ Ort">
            <input type="email" id="c-mail" class="form-control mb-1" placeholder="E-Mail">
            <input type="text" id="c-phone" class="form-control mb-1" placeholder="Telefon">
            <button onclick="saveCustomer()" class="btn btn-primary btn-sm w-100 mt-2">Speichern</button>
            <div id="cust-list" class="list-group mt-3"></div>
        </div>
    </div></div></div>

    <div class="modal fade" id="modal-scan" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header bg-warning"><h6>üì∏ Beleg Scanner</h6><button class="btn-close" data-bs-dismiss="modal" onclick="stopCam()"></button></div>
        <div class="modal-body text-center"><video id="cam-video" style="width:100%; border-radius:10px;" autoplay playsinline></video><button onclick="captureAndScan()" class="btn btn-primary mt-3 w-100">Scan</button></div>
    </div></div></div>

    <script>
        let db = JSON.parse(localStorage.getItem('h2_final_v10') || '{"invoices":[], "expenses":[], "customers":[]}');  // Version hochgesetzt f√ºr Kompatibilit√§t
        document.getElementById('inv-date').textContent = new Date().toLocaleDateString('de-DE');
        let stream = null;
        let currentInvoice = { items: [], customer: null };  // Tempor√§re Speicherung der aktuellen Rechnung

        function addRow(desc = '', qty = 1, price = 0, tax = 19) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><input type="text" class="form-control form-control-sm border-0 p-0 desc" value="${desc}"></td>
                <td><input type="number" class="form-control form-control-sm border-0 text-center qt" value="${qty}" oninput="calc()"></td>
                <td><input type="number" class="form-control form-control-sm border-0 text-end pr" value="${price}" oninput="calc()"></td>
                <td><input type="number" class="form-control form-control-sm border-0 text-center tx" value="${tax}" oninput="calc()"></td>
                <td class="text-end fw-bold lt">0,00 ‚Ç¨</td>
                <td class="no-print"><button onclick="this.closest('tr').remove();calc();" class="btn btn-sm text-danger">√ó</button></td>`;
            document.getElementById('inv-items').appendChild(tr);
            calc();
        }

        function calc() {
            let netTotal = 0, taxTotal = 0;
            document.querySelectorAll('#inv-items tr').forEach(row => {
                const qty = parseFloat(row.querySelector('.qt').value) || 0;
                const price = parseFloat(row.querySelector('.pr').value) || 0;
                const taxRate = parseFloat(row.querySelector('.tx').value) || 0;
                const net = qty * price;
                const tax = net * (taxRate / 100);
                const gross = net + tax;
                row.querySelector('.lt').textContent = gross.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
                netTotal += net;
                taxTotal += tax;
            });
            const grossTotal = netTotal + taxTotal;
            document.getElementById('sum-n').textContent = netTotal.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
            document.getElementById('sum-t').textContent = taxTotal.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
            document.getElementById('sum-g').textContent = grossTotal.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'});
        }

        function saveInvoice() {
            const nr = document.getElementById('inv-nr').textContent.trim();
            if (!/^[a-zA-Z0-9-]+$/.test(nr)) { alert('Ung√ºltige Rechnungsnummer (nur Buchstaben, Zahlen, - erlaubt)'); return; }
            currentInvoice.items = Array.from(document.querySelectorAll('#inv-items tr')).map(row => ({
                desc: row.querySelector('.desc').value,
                qty: parseFloat(row.querySelector('.qt').value),
                price: parseFloat(row.querySelector('.pr').value),
                tax: parseFloat(row.querySelector('.tx').value)
            }));
            currentInvoice.customer = db.customers.find(c => c.name === document.getElementById('cust-display').querySelector('span').textContent) || null;
            const gross = parseFloat(document.getElementById('sum-g').textContent.replace(/[^0-9,.]/g, '').replace(',', '.'));
            const tax = parseFloat(document.getElementById('sum-t').textContent.replace(/[^0-9,.]/g, '').replace(',', '.'));
            db.invoices.push({ date: new Date().toLocaleDateString('de-DE'), nr, gross, tax, items: currentInvoice.items, customer: currentInvoice.customer });
            localStorage.setItem('h2_final_v10', JSON.stringify(db));
            alert('Rechnung gespeichert!');
            resetInvoice();
        }

        function resetInvoice() {
            document.getElementById('inv-nr').textContent = 'H2-2026-' + (db.invoices.length + 1).toString().padStart(3, '0');
            document.getElementById('inv-items').innerHTML = '';
            document.getElementById('cust-display').innerHTML = '<span>(Kunde w√§hlen...)</span>';
            addRow();
        }

        function showStats() {
            let grossTotal = 0, taxTotal = 0, expenseTotal = 0;
            const tableBody = document.getElementById('stat-table');
            tableBody.innerHTML = '';
            db.invoices.forEach((inv, idx) => {
                grossTotal += inv.gross;
                taxTotal += inv.tax;
                const row = document.createElement('tr');
                row.className = 'table-success';
                row.innerHTML = `<td>Rechnung</td><td>\( {inv.nr}</td><td>+ \){inv.tax.toFixed(2)}‚Ç¨</td><td>${inv.gross.toFixed(2)}‚Ç¨</td>
                                 <td><button class="btn btn-xs btn-info" onclick="loadInvoice(${idx})">Laden</button></td>`;
                tableBody.appendChild(row);
            });
            db.expenses.forEach((ex, idx) => {
                expenseTotal += ex.amt;
                const row = document.createElement('tr');
                row.className = 'table-danger';
                row.innerHTML = `<td>Ausgabe</td><td>Beleg vom \( {ex.date}</td><td>-</td><td>- \){ex.amt.toFixed(2)}‚Ç¨</td><td></td>`;
                tableBody.appendChild(row);
            });
            document.getElementById('st-brutto').textContent = grossTotal.toFixed(2) + '‚Ç¨';
            document.getElementById('st-steuer').textContent = taxTotal.toFixed(2) + '‚Ç¨';
            document.getElementById('st-ausg').textContent = expenseTotal.toFixed(2) + '‚Ç¨';
            document.getElementById('st-gewinn').textContent = (grossTotal - taxTotal - expenseTotal).toFixed(2) + '‚Ç¨';
            new bootstrap.Modal(document.getElementById('modal-stats')).show();
        }

        function loadInvoice(idx) {
            const inv = db.invoices[idx];
            document.getElementById('inv-nr').textContent = inv.nr;
            document.getElementById('inv-date').textContent = inv.date;
            document.getElementById('inv-items').innerHTML = '';
            inv.items.forEach(item => addRow(item.desc, item.qty, item.price, item.tax));
            if (inv.customer) selectCust(inv.customer, true);
            calc();
            bootstrap.Modal.getInstance(document.getElementById('modal-stats')).hide();
        }

        function share(platform) { 
            const msg = encodeURIComponent(`H2TechService Rechnung: ${document.getElementById('sum-g').textContent}`);
            window.open(platform === 'whatsapp' ? `https://wa.me/?text=\( {msg}` : `https://t.me/share/url?url= \){msg}`);
        }

        function exportToCSV() {
            let csv = 'Datum;Typ;Info;MwSt;Betrag\n';
            db.invoices.forEach(inv => csv += `\( {inv.date};Rechnung; \){inv.nr};\( {inv.tax.toFixed(2)}; \){inv.gross.toFixed(2)}\n`);
            db.expenses.forEach(ex => csv += `\( {ex.date};Ausgabe;Beleg;-; \){ex.amt.toFixed(2)}\n`);
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
            link.download = 'H2_Bilanz.csv';
            link.click();
        }

        function downloadPDF() { 
            html2pdf().from(document.getElementById('pdf-area')).set({margin: 0, filename: 'H2_Rechnung.pdf', jsPDF: {format: 'a4'}}).save(); 
        }

        async function openScanner() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}});
                document.getElementById('cam-video').srcObject = stream;
                new bootstrap.Modal(document.getElementById('modal-scan')).show();
            } catch (err) {
                alert('Kamera-Zugriff fehlgeschlagen: ' + err.message);
            }
        }

        function stopCam() {
            if (stream) stream.getTracks().forEach(track => track.stop());
        }

        async function captureAndScan() {
            const video = document.getElementById('cam-video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            try {
                const {data: {text}} = await Tesseract.recognize(canvas.toDataURL(), 'deu');
                // Bessere Erkennung: Suche nach Schl√ºsselw√∂rtern und nahen Betr√§gen
                const lines = text.split('\n');
                let amt = 0;
                const keywords = ['gesamt', 'summe', 'zu zahlen', 'total', 'brutto'];
                lines.forEach(line => {
                    const lowerLine = line.toLowerCase();
                    if (keywords.some(kw => lowerLine.includes(kw))) {
                        const matches = line.match(/\d+[,.]\d{2}/g);
                        if (matches) {
                            const candidate = Math.max(...matches.map(m => parseFloat(m.replace(',', '.'))));
                            if (candidate > amt) amt = candidate;
                        }
                    }
                });
                if (amt > 0) {
                    db.expenses.push({amt, date: new Date().toLocaleDateString('de-DE')});
                    localStorage.setItem('h2_final_v10', JSON.stringify(db));
                    alert(`Erkannter Betrag: ${amt.toFixed(2)}‚Ç¨`);
                } else {
                    alert('Kein g√ºltiger Betrag erkannt.');
                }
            } catch (err) {
                alert('Scan-Fehler: ' + err.message);
            }
            stopCam();
            bootstrap.Modal.getInstance(document.getElementById('modal-scan')).hide();
        }

        function saveCustomer() {
            const name = document.getElementById('c-name').value.trim();
            if (!name) { alert('Name erforderlich!'); return; }
            const customer = {
                name,
                street: document.getElementById('c-street').value.trim(),
                city: document.getElementById('c-city').value.trim(),
                mail: document.getElementById('c-mail').value.trim(),
                phone: document.getElementById('c-phone').value.trim()
            };
            db.customers.push(customer);
            localStorage.setItem('h2_final_v10', JSON.stringify(db));
            openCustomerModal();  // Liste aktualisieren
        }

        function openCustomerModal() {
            const list = document.getElementById('cust-list');
            list.innerHTML = '';
            db.customers.forEach((c, i) => {
                const btn = document.createElement('button');
                btn.className = 'list-group-item list-group-item-action small';
                btn.textContent = c.name;
                btn.onclick = () => {
                    selectCust(c);
                    bootstrap.Modal.getInstance(document.getElementById('modal-cust')).hide();
                };
                list.appendChild(btn);
            });
            // Formulare leeren
            document.getElementById('c-name').value = '';
            document.getElementById('c-street').value = '';
            document.getElementById('c-city').value = '';
            document.getElementById('c-mail').value = '';
            document.getElementById('c-phone').value = '';
            new bootstrap.Modal(document.getElementById('modal-cust')).show();
        }

        function selectCust(customer, fromLoad = false) {
            document.getElementById('cust-display').innerHTML = `
                <span>${customer.name}</span><br>
                <span>${customer.street}</span><br>
                <span>${customer.city}</span><br>
                <span>üìß ${customer.mail}</span><br>
                <span>üìû ${customer.phone}</span>
            `;
            if (!fromLoad) bootstrap.Modal.getInstance(document.getElementById('modal-cust')).hide();
        }

        // Initialisierung
        resetInvoice();
    </script>
</body>
</html>
