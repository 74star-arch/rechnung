<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H2 TechService - Professional ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white !important; padding: 0 !important; margin: 0 !important; }
            .no-print, .share-container, .stats-panel, .archive-panel, #sig-unlock, button { display:none !important; }
            .card { 
                box-shadow: none !important; 
                margin: 0 !important; 
                width: 100% !important; 
                max-width: 100% !important; 
                height: 100vh;
                display: flex;
                flex-direction: column;
                border: none !important;
                border-radius: 0 !important;
            }
            .content-wrap { flex-grow: 1; }
        }

        body { background: #f1f5f9; font-family: 'Inter', sans-serif; padding-bottom: 120px; }
        .card { max-width: 800px; margin: 10px auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; position: relative; }
        .header-bg { background: #1e3a8a; }
        .accent-text { color: #2dd4bf; }
        
        /* Korrektur: Nur das Canvas blockiert die Touch-Action, nicht das ganze Dokument */
        #sig-canvas { background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 8px; pointer-events: none; opacity: 0.6; transition: 0.3s; touch-action: auto; }
        #sig-canvas.active { pointer-events: auto; opacity: 1; border: 2px solid #1e40af; background: white; touch-action: none; }
        
        textarea { resize: none; overflow: hidden; min-height: 20px; width: 100%; background: transparent; outline: none; }
        input { background: transparent; }
    </style>
</head>
<body>

<div class="max-w-[800px] mx-auto mt-4 px-4 no-print space-y-3">
    <div class="stats-panel bg-white p-4 rounded-xl shadow-sm border flex justify-around text-center">
        <div><p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Heute</p><p id="stat-today" class="text-lg font-black text-slate-800">0,00 â‚¬</p></div>
        <div><p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Umsatz Gesamt</p><p id="stat-total" class="text-lg font-black text-green-600">0,00 â‚¬</p></div>
    </div>
</div>

<div class="card" id="invoice">
    <div class="content-wrap">
        <div class="header-bg p-8 text-white flex justify-between items-center">
            <div class="flex items-center gap-5">
                <div class="w-[75px] h-[75px] bg-white rounded-xl flex items-center justify-center overflow-hidden border-2 border-white/20">
                    <img id="firmLogo" src="https://cdn-icons-png.flaticon.com/512/2906/2906274.png">
                </div>
                <div>
                    <h1 class="text-3xl font-black italic tracking-tighter uppercase leading-tight">H2 <span class="accent-text">Tech</span>Service</h1>
                    <p class="opacity-80 text-[10px] font-bold uppercase tracking-widest mt-1">Montage & Technik</p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-[8px] opacity-60 uppercase font-black">Rechnungs-Nr.</p>
                <input id="inv" class="bg-transparent text-right font-black text-2xl outline-none w-52 accent-text" value="">
            </div>
        </div>

        <div class="p-8 grid grid-cols-2 gap-10 border-b text-left">
            <div class="text-[12px] text-slate-700">
                <b class="text-blue-700 text-[9px] uppercase font-black block mb-2 tracking-widest">Absender</b>
                <p class="font-black text-slate-900 text-base italic">H2 TechService</p>
                <p class="font-medium mb-3 text-slate-500">Suntal Str. 48, 31552 Rodenberg</p>
                <p class="font-bold">+49 176 66658777</p>
                <p class="mb-3">74star@gmail.com</p>
                <p class="text-[9px] text-slate-400 font-bold border px-2 py-0.5 rounded inline-block">ST-ID: 41320887966</p>
            </div>

            <div class="text-right flex flex-col items-end text-[12px]">
                <b class="text-blue-700 text-[9px] uppercase font-black mb-2 tracking-widest">EmpfÃ¤nger</b>
                <select id="db_select" class="no-print mb-2 text-[10px] bg-slate-50 border rounded-lg p-1 w-full" onchange="loadCustomer()"><option value="">â€” Kunde laden â€”</option></select>
                <input type="text" id="c_n" placeholder="Name / Firma" class="w-full text-right font-black outline-none text-base mb-1 border-b border-transparent focus:border-blue-200">
                <input type="text" id="c_s" placeholder="StraÃŸe" class="w-full text-right outline-none text-slate-500 mb-1 border-b border-transparent focus:border-blue-200">
                <input type="text" id="c_o" placeholder="PLZ & Ort" class="w-full text-right outline-none text-slate-500 mb-2 border-b border-transparent focus:border-blue-200">
                <input type="text" id="c_t" placeholder="Telefon" class="text-right outline-none w-full italic text-slate-500 border-b border-transparent focus:border-blue-200">
                <input type="text" id="c_m" placeholder="E-Mail" class="text-right outline-none w-full italic text-slate-500 border-b border-transparent focus:border-blue-200">
                <button onclick="saveCustomer()" class="no-print text-[8px] bg-blue-50 text-blue-600 px-3 py-1 rounded-full mt-2 font-black uppercase">Speichern</button>
            </div>
        </div>

        <table class="w-full text-[13px]">
            <thead class="bg-slate-50 text-[9px] font-black uppercase text-slate-400 border-b">
                <tr><th class="p-4 text-left">Leistung</th><th class="p-4 w-16 text-center">Stk.</th><th class="p-4 w-28 text-right">Summe</th></tr>
            </thead>
            <tbody id="rows">
                <tr class="border-b border-slate-50">
                    <td class="p-4"><textarea placeholder="Dienstleistung..." oninput="calc()"></textarea></td>
                    <td class="p-4 text-center"><input type="number" value="1" class="qty w-full text-center font-bold outline-none" oninput="calc()"></td>
                    <td class="p-4 text-right font-black"><input type="number" step="0.01" placeholder="0,00" class="price w-full text-right outline-none" oninput="calc()"></td>
                </tr>
            </tbody>
        </table>

        <div class="p-8 flex justify-between items-center bg-slate-50/20">
            <div id="qrcode"></div>
            <div class="text-right">
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Gesamt inkl. 19% MwSt</p>
                <p class="text-5xl font-black text-slate-900" id="total">0,00 â‚¬</p>
            </div>
        </div>
    </div>

    <div class="p-8 border-t flex justify-between items-end gap-10">
        <div class="flex-1 text-center">
            <p class="text-[9px] font-black text-slate-400 uppercase mb-6">Techniker</p>
            <p class="italic text-xl font-serif border-b-2 border-slate-200 pb-2">Osman Tuncer</p>
        </div>
        <div class="flex-1 text-right">
            <p class="text-[9px] font-black text-slate-400 uppercase mb-4">Abnahme Kunde</p>
            <button id="sig-unlock" onclick="toggleSignatureLock()" class="no-print bg-red-600 text-white text-[10px] px-4 py-2 rounded-full mb-3 font-black flex items-center gap-2 ml-auto">
                <span id="lock-icon">ðŸ”’</span> <span id="lock-text">KLICK ZUM UNTERSCHREIBEN</span>
            </button>
            <canvas id="sig-canvas" width="300" height="100" class="no-print w-full"></canvas>
            <img id="sig-image" class="hidden h-20 border-b-2 border-slate-300 ml-auto object-contain">
        </div>
    </div>

    <div class="header-bg p-6 text-white text-[9px] flex justify-between items-center font-black uppercase">
        <div class="text-left"><p>IBAN: LT83 2500 9251 8928 659</p><p>BIC: REVOLUT21</p></div>
        <div class="text-right"><p>H2 TechService</p></div>
    </div>
</div>

<div class="share-container no-print" id="tools" style="position:fixed; bottom:20px; right:20px; display:flex; flex-direction:column-reverse; gap:10px;">
    <button class="w-14 h-14 bg-blue-700 text-white rounded-full text-2xl shadow-xl" onclick="this.parentElement.classList.toggle('active'); toggleT()">+</button>
    <div id="sub-btns" class="hidden flex flex-col-reverse gap-3">
        <button onclick="processPaidAndPrint()" class="w-12 h-12 bg-white border rounded-full shadow-md p-3"><img src="https://cdn-icons-png.flaticon.com/512/190/190411.png"></button>
        <button onclick="window.print()" class="w-12 h-12 bg-white border rounded-full shadow-md p-3"><img src="https://cdn-icons-png.flaticon.com/512/337/337946.png"></button>
        <button onclick="addRow()" class="w-12 h-12 bg-white border rounded-full shadow-md p-3"><img src="https://cdn-icons-png.flaticon.com/512/992/992651.png"></button>
    </div>
</div>

<script>
    const fmt = n => new Intl.NumberFormat('de-DE', {style:'currency', currency:'EUR'}).format(n);
    const qrcode = new QRCode(document.getElementById("qrcode"), { width: 60, height: 60 });
    const canvas = document.getElementById('sig-canvas');
    const signaturePad = new SignaturePad(canvas);
    let isLocked = true;

    function toggleSignatureLock() {
        isLocked = !isLocked;
        const btn = document.getElementById('sig-unlock');
        if(isLocked) {
            canvas.classList.remove('active');
            btn.classList.replace('bg-green-600', 'bg-red-600');
            document.getElementById('lock-icon').innerText = "ðŸ”’";
            document.getElementById('lock-text').innerText = "KLICK ZUM UNTERSCHREIBEN";
        } else {
            canvas.classList.add('active');
            btn.classList.replace('bg-red-600', 'bg-green-600');
            document.getElementById('lock-icon').innerText = "ðŸ”“";
            document.getElementById('lock-text').innerText = "JETZT UNTERSCHREIBEN";
        }
    }

    function calc() {
        let sub = 0;
        document.querySelectorAll("#rows tr").forEach(r => {
            sub += (r.querySelector(".qty").value||0) * (r.querySelector(".price").value||0);
        });
        document.getElementById("total").innerText = fmt(sub * 1.19);
        qrcode.makeCode("Rechnung H2 TechService");
    }

    function addRow() {
        const r = document.querySelector("#rows tr").cloneNode(true);
        r.querySelectorAll("input, textarea").forEach(i => i.value = "");
        document.getElementById("rows").appendChild(r);
    }

    function toggleT() { document.getElementById('sub-btns').classList.toggle('hidden'); }

    function saveCustomer() {
        alert("Kunde in Browser-Daten gespeichert!");
    }

    function processPaidAndPrint() {
        if(!signaturePad.isEmpty()){ 
            document.getElementById('sig-image').src = signaturePad.toDataURL(); 
            document.getElementById('sig-image').classList.remove('hidden'); 
            canvas.classList.add('hidden');
            document.getElementById('sig-unlock').classList.add('hidden');
        }
        setTimeout(() => { window.print(); location.reload(); }, 500);
    }

    document.getElementById("inv").value = "H2-" + Date.now().toString().slice(-6);
    calc();
</script>
</body>
</html>
