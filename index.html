<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rechnung ‚Äì H2TechService</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background: #f0f3f7; padding: 10px; font-family: 'Segoe UI', Arial, sans-serif; font-size: 15px; }
        body.dark-mode { background: #121212; color: #e0e0e0; }
        .invoice-box {
            max-width: 900px;
            margin: 10px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        body.dark-mode .invoice-box { background: #1e1e1e; }
        .header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            color: white;
            padding: 25px 20px;
            text-align: center;
        }
        .header h1 { margin: 0; font-size: 32px; font-weight: 700; }
        .content { padding: 20px; line-height: 1.4; }
        body.dark-mode .content { color: #e0e0e0; }
        .section-title { font-size: 16px; font-weight: 600; color: #333; margin: 15px 0 8px; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; }
        body.dark-mode .section-title { color: #e0e0e0; }
        .table { font-size: 14px; margin-bottom: 10px; }
        .table thead { background: var(--primary-color); color: white; }
        .table th, .table td { padding: 8px; vertical-align: middle; }
        .summary { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-top: 20px; font-size: 16px; }
        body.dark-mode .summary { background: #2d2d2d; }
        .total-row { border-top: 3px solid var(--primary-color); font-weight: bold; }
        .card { font-size: 14px; }
        .btn { margin: 3px; font-size: 14px; padding: 8px 12px; }
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white; padding: 0; margin: 0; font-size: 11pt; line-height: 1.3; }
            .no-print { display: none !important; }
            .invoice-box {
                box-shadow: none;
                border-radius: 0;
                margin: 0;
                padding: 0;
                max-width: none;
                width: 190mm;
                min-height: 277mm;
                box-sizing: border-box;
            }
            .header { padding: 15px; }
            .header h1 { font-size: 24pt; }
            .content { padding: 15px; }
            .section-title { font-size: 12pt; margin: 10px 0 5px; }
            .table { font-size: 10pt; }
            .table th, .table td { padding: 5px; }
            .summary { padding: 10px; font-size: 12pt; }
            .mt-4, .mt-5 { margin-top: 10px !important; }
            #invoice-logo { max-height: 70px; }
        }
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
        }
    </style>
</head>
<body>

    <div class="container no-print text-center mb-3">
        <button id="save-invoice" class="btn btn-success">üíæ Speichern</button>
        <button id="pdf-download" class="btn btn-primary">üìÑ PDF</button>
        <button id="excel-download" class="btn btn-info">üìä Excel</button>
        <button id="email-send" class="btn btn-warning">‚úâÔ∏è E-Mail</button>
        <button id="print-button" class="btn btn-secondary">üñ®Ô∏è Drucken</button>
        <button id="new-invoice" class="btn btn-danger">üÜï Neue Rechnung</button>
        <button id="show-archive" class="btn btn-outline-dark">üìÅ Archiv</button>
    </div>

    <div class="container no-print mb-4">
        <div class="row g-2">
            <div class="col-6 col-md-3">
                <div class="card p-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="dark-mode-switch">
                        <label class="form-check-label" for="dark-mode-switch">Dark Mode</label>
                    </div>
                    <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="kleinunternehmer-mode">
                        <label class="form-check-label" for="kleinunternehmer-mode">Kleinunternehmer (¬ß19)</label>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card p-3">
                    <label>Firmenname</label>
                    <input type="text" id="company-name" class="form-control" value="H2TechService">
                    <label class="mt-2">Farbe</label>
                    <input type="color" id="color-picker" class="form-control form-control-color" value="#007bff">
                </div>
            </div>
            <div class="col-6 col-md-3">
                <div class="card p-3">
                    <label>Standard MwSt. (%)</label>
                    <input type="number" id="default-tax-rate" class="form-control text-center" value="19" step="0.1">
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12 col-md-8">
                <div class="card p-3">
                    <label>Allgemeine Gesch√§ftsbedingungen (erscheint nur bei Inhalt)</label>
                    <textarea id="agb-text" class="form-control" rows="3" placeholder="Deine AGB hier eingeben..."></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="invoice-box" id="invoice-content">
        <div class="header">
            <h1>Rechnung</h1>
        </div>
        <div class="content">
            <div class="row info-block">
                <div class="col-md-6">
                    <div class="section-title">Absender</div>
                    <strong id="display-company-name">H2TechService</strong><br>
                    Suntalstra√üe 48<br>
                    31552 Rodenberg<br>
                    Deutschland<br><br>
                    Steuer-ID: 41/320/887966<br>
                    E-Mail: 74star@gmail.com<br>
                    Telefon: +49 176 66658777
                </div>
                <div class="col-md-6 text-md-end">
                    <img id="invoice-logo" src="https://cdn.grok.x.ai/assets/images/1/1.jpg" style="max-height: 90px;"><br>
                    <strong>Rechnungsnummer:</strong> <span id="invoice-number">H220260001</span><br>
                    <strong>Rechnungsdatum:</strong> <span id="invoice-date"></span>
                </div>
            </div>

            <div class="row info-block no-print">
                <div class="col-12">
                    <div class="section-title">Kunde</div>
                    <div class="row g-2">
                        <div class="col-6">
                            <select id="customer-select" class="form-select">
                                <option value="">-- Neuen Kunden anlegen --</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <button id="save-customer" class="btn btn-outline-primary w-100">Kunde speichern</button>
                        </div>
                        <div class="col-6"><input type="text" id="customer-name" class="form-control" placeholder="Name/Firma"></div>
                        <div class="col-6"><input type="text" id="customer-street" class="form-control" placeholder="Stra√üe"></div>
                        <div class="col-4"><input type="text" id="customer-city" class="form-control" placeholder="PLZ Ort"></div>
                        <div class="col-8"><input type="text" id="customer-email" class="form-control" placeholder="E-Mail"></div>
                    </div>
                </div>
            </div>

            <div class="row info-block">
                <div class="col-md-6">
                    <div class="section-title">Rechnung an</div>
                    <div id="customer-info">Bitte Kunden ausw√§hlen oder anlegen.</div>
                </div>
            </div>

            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Beschreibung</th>
                        <th class="text-center">Menge</th>
                        <th class="text-end">Einzelpreis (‚Ç¨)</th>
                        <th class="text-center">MwSt. (%)</th>
                        <th class="text-end">Gesamt (‚Ç¨)</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="invoice-items">
                    <tr class="item">
                        <td><input type="text" class="form-control border-0 desc-input" placeholder="Beschreibung"></td>
                        <td class="text-center"><input type="number" class="form-control text-center qty border-0" value="1" min="1"></td>
                        <td class="text-end"><input type="number" class="form-control text-end price border-0" value="0.00" step="0.01"></td>
                        <td class="text-center"><input type="number" class="form-control text-center tax-rate-input border-0" value="19" min="0" step="0.1"></td>
                        <td class="line-total text-end">0,00</td>
                        <td class="text-center"><button class="btn btn-sm btn-outline-danger remove">X</button></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="6" class="text-end">
                            <button id="add-row" class="btn btn-primary">+ Position hinzuf√ºgen</button>
                        </td>
                    </tr>
                </tfoot>
            </table>

            <div class="row">
                <div class="col-md-6 offset-md-6">
                    <div class="summary">
                        <table class="w-100">
                            <tr>
                                <td><strong>Nettobetrag</strong></td>
                                <td class="text-end" id="subtotal">0,00 ‚Ç¨</td>
                            </tr>
                            <tr>
                                <td>Rabatt</td>
                                <td class="text-end"><input type="number" id="discount" class="form-control text-end d-inline-block" value="0.00" step="0.01" style="width:100px;"> ‚Ç¨</td>
                            </tr>
                            <tr id="tax-row">
                                <td>zzgl. MwSt.</td>
                                <td class="text-end" id="tax">0,00 ‚Ç¨</td>
                            </tr>
                            <tr id="kleinunternehmer-hinweis" class="d-none">
                                <td colspan="2" class="text-end fst-italic">Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer ausgewiesen.</td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>Gesamtbetrag</strong></td>
                                <td class="text-end" id="grandtotal"><strong>0,00 ‚Ç¨</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <div class="section-title">Zahlungsinformationen</div>
                Bank: Revolut<br>
                IBAN: LT78 3250 0925 1892 8659<br>
                BIC: REVOLT21<br><br>
                Vielen Dank f√ºr Ihren Auftrag!<br>
                Bei Fragen stehen wir gerne zur Verf√ºgung.
            </div>

            <div class="mt-4 d-none" id="agb-section">
                <div class="section-title">Allgemeine Gesch√§ftsbedingungen</div>
                <div id="agb-content"></div>
            </div>
        </div>
    </div>

    <!-- Archiv Modal -->
    <div class="modal fade" id="archive-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rechnungsarchiv</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-hover" id="archive-table">
                        <thead class="table-light">
                            <tr>
                                <th>Rechnungsnummer</th>
                                <th>Datum</th>
                                <th>Kunde</th>
                                <th>Gesamtbetrag</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        // Dark Mode
        const darkSwitch = document.getElementById('dark-mode-switch');
        darkSwitch.addEventListener('change', () => {
            document.body.classList.toggle('dark-mode', darkSwitch.checked);
            localStorage.setItem('h2DarkMode', darkSwitch.checked);
        });
        if (localStorage.getItem('h2DarkMode') === 'true') document.body.classList.add('dark-mode');

        // Firmenname
        const companyInput = document.getElementById('company-name');
        const companyDisplay = document.getElementById('display-company-name');
        companyInput.addEventListener('input', () => {
            companyDisplay.textContent = companyInput.value || 'H2TechService';
            localStorage.setItem('h2CompanyName', companyInput.value);
        });
        const savedCompany = localStorage.getItem('h2CompanyName');
        if (savedCompany) companyInput.value = savedCompany, companyDisplay.textContent = savedCompany;

        // Farbe
        const colorPicker = document.getElementById('color-picker');
        colorPicker.addEventListener('input', e => {
            const color = e.target.value;
            document.documentElement.style.setProperty('--primary-color', color);
            document.documentElement.style.setProperty('--primary-dark', adjustColor(color, -40));
            localStorage.setItem('h2PrimaryColor', color);
        });
        function adjustColor(color, amount) {
            return '#' + color.replace(/^#/, '').replace(/../g, c => ('0'+Math.min(255, Math.max(0, parseInt(c, 16) + amount)).toString(16)).substr(-2));
        }
        const savedColor = localStorage.getItem('h2PrimaryColor');
        if (savedColor) colorPicker.value = savedColor, colorPicker.dispatchEvent(new Event('input'));

        // Logo fest eingebaut
        document.getElementById('invoice-logo').src = 'https://cdn.grok.x.ai/assets/images/1/1.jpg';

        // Standard MwSt.
        const defaultTaxRate = document.getElementById('default-tax-rate');

        // Kleinunternehmer
        const kleinSwitch = document.getElementById('kleinunternehmer-mode');
        const taxRow = document.getElementById('tax-row');
        const kleinHinweis = document.getElementById('kleinunternehmer-hinweis');
        kleinSwitch.addEventListener('change', () => {
            if (kleinSwitch.checked) {
                document.querySelectorAll('.tax-rate-input').forEach(input => input.value = 0);
                taxRow.classList.add('d-none');
                kleinHinweis.classList.remove('d-none');
            } else {
                document.querySelectorAll('.tax-rate-input').forEach(input => input.value = defaultTaxRate.value);
                taxRow.classList.remove('d-none');
                kleinHinweis.classList.add('d-none');
            }
            calculate();
        });
        if (localStorage.getItem('h2Kleinunternehmer') === 'true') kleinSwitch.checked = true, kleinSwitch.dispatchEvent(new Event('change'));

        // AGB
        const agbText = document.getElementById('agb-text');
        const agbSection = document.getElementById('agb-section');
        const agbContent = document.getElementById('agb-content');
        function updateAGB() {
            const text = agbText.value.trim();
            if (text === '') {
                agbSection.classList.add('d-none');
            } else {
                agbSection.classList.remove('d-none');
                agbContent.innerHTML = text.replace(/\n/g, '<br>');
            }
        }
        agbText.addEventListener('input', updateAGB);
        updateAGB();

        // Automatisches Rechnungsdatum vom Smartphone
        function setCurrentDate() {
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yyyy = today.getFullYear();
            const dateStr = `\( {dd}. \){mm}.${yyyy}`;
            document.getElementById('invoice-date').textContent = dateStr;
        }

        // Rechnungsnummer ‚Äì hochz√§hlen NUR beim Speichern
        const invoiceNumberDisplay = document.getElementById('invoice-number');

        function generateNextNumber() {
            let counter = parseInt(localStorage.getItem('h2InvoiceCounter') || '0');
            counter++;
            const newNumber = `H22026${String(counter).padStart(4, '0')}`;
            invoiceNumberDisplay.textContent = newNumber;
            localStorage.setItem('h2InvoiceCounter', counter);
        }

        document.getElementById('save-invoice').addEventListener('click', () => {
            generateNextNumber();
            saveCurrentInvoice();
            alert('Rechnung gespeichert ‚Äì neue Nummer f√ºr n√§chste Rechnung bereit!');
        });

        document.getElementById('new-invoice').addEventListener('click', () => {
            generateNextNumber();
            location.reload();
        });

        if (!localStorage.getItem('h2InvoiceCounter')) {
            localStorage.setItem('h2InvoiceCounter', '0');
        }
        const currentCounter = parseInt(localStorage.getItem('h2InvoiceCounter') || '0');
        invoiceNumberDisplay.textContent = `H22026${String(currentCounter + 1).padStart(4, '0')}`;

        // Kundenverwaltung
        const customerSelect = document.getElementById('customer-select');
        const customerName = document.getElementById('customer-name');
        const customerStreet = document.getElementById('customer-street');
        const customerCity = document.getElementById('customer-city');
        const customerEmail = document.getElementById('customer-email');
        const customerInfo = document.getElementById('customer-info');

        function loadCustomers() {
            const customers = JSON.parse(localStorage.getItem('h2Customers') || '[]');
            customerSelect.innerHTML = '<option value="">-- Neuen Kunden anlegen --</option>';
            customers.forEach((cust, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = cust.name || 'Unbenannter Kunde';
                customerSelect.appendChild(option);
            });
        }

        function updateCustomerInfo() {
            let html = '';
            if (customerName.value) html += customerName.value + '<br>';
            if (customerStreet.value) html += customerStreet.value + '<br>';
            if (customerCity.value) html += customerCity.value + '<br>';
            html += 'Deutschland<br><br>';
            if (customerEmail.value) html += 'E-Mail: ' + customerEmail.value;
            customerInfo.innerHTML = html || 'Bitte Kunden ausw√§hlen oder anlegen.';
        }

        document.getElementById('save-customer').addEventListener('click', () => {
            if (!customerName.value.trim()) {
                alert('Bitte mindestens den Namen eingeben!');
                return;
            }
            const customers = JSON.parse(localStorage.getItem('h2Customers') || '[]');
            const newCustomer = {
                name: customerName.value.trim(),
                street: customerStreet.value.trim(),
                city: customerCity.value.trim(),
                email: customerEmail.value.trim()
            };
            customers.push(newCustomer);
            localStorage.setItem('h2Customers', JSON.stringify(customers));
            loadCustomers();
            customerSelect.value = customers.length - 1;
            updateCustomerInfo();
            alert('Kunde gespeichert!');
        });

        customerSelect.addEventListener('change', () => {
            const index = customerSelect.value;
            if (index === '') {
                customerName.value = '';
                customerStreet.value = '';
                customerCity.value = '';
                customerEmail.value = '';
                updateCustomerInfo();
                return;
            }
            const customers = JSON.parse(localStorage.getItem('h2Customers') || '[]');
            const cust = customers[index];
            if (cust) {
                customerName.value = cust.name || '';
                customerStreet.value = cust.street || '';
                customerCity.value = cust.city || '';
                customerEmail.value = cust.email || '';
                updateCustomerInfo();
            }
        });

        [customerName, customerStreet, customerCity, customerEmail].forEach(input => {
            input.addEventListener('input', updateCustomerInfo);
        });

        loadCustomers();
        updateCustomerInfo();

        // Berechnung
        function calculate() {
            let subtotal = 0;
            let totalTax = 0;
            document.querySelectorAll('.item').forEach(row => {
                const qty = parseFloat(row.querySelector('.qty').value) || 0;
                const price = parseFloat(row.querySelector('.price').value) || 0;
                const net = qty * price;
                const taxRateLine = parseFloat(row.querySelector('.tax-rate-input').value) / 100 || 0;
                const taxLine = net * taxRateLine;
                const totalLine = net + taxLine;
                row.querySelector('.line-total').textContent = totalLine.toFixed(2).replace('.', ',');
                subtotal += net;
                totalTax += taxLine;
            });
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const taxable = subtotal - discount;
            const grand = taxable + totalTax;

            document.getElementById('subtotal').textContent = subtotal.toFixed(2).replace('.', ',') + ' ‚Ç¨';
            document.getElementById('tax').textContent = totalTax.toFixed(2).replace('.', ',') + ' ‚Ç¨';
            document.getElementById('grandtotal').innerHTML = '<strong>' + grand.toFixed(2).replace('.', ',') + ' ‚Ç¨</strong>';
        }

        document.getElementById('invoice-items').addEventListener('input', e => {
            if (e.target.classList.contains('qty') || e.target.classList.contains('price') || e.target.classList.contains('tax-rate-input')) calculate();
        });
        document.getElementById('discount').addEventListener('input', calculate);

        // + Position
        document.getElementById('add-row').addEventListener('click', () => {
            const tbody = document.getElementById('invoice-items');
            const newRow = document.createElement('tr');
            newRow.className = 'item';
            newRow.innerHTML = `
                <td><input type="text" class="form-control border-0 desc-input" placeholder="Beschreibung"></td>
                <td class="text-center"><input type="number" class="form-control text-center qty border-0" value="1" min="1"></td>
                <td class="text-end"><input type="number" class="form-control text-end price border-0" value="0.00" step="0.01"></td>
                <td class="text-center"><input type="number" class="form-control text-center tax-rate-input border-0" value="${defaultTaxRate.value}" min="0" step="0.1"></td>
                <td class="line-total text-end">0,00</td>
                <td class="text-center"><button class="btn btn-sm btn-outline-danger remove">X</button></td>
            `;
            tbody.appendChild(newRow);
            newRow.querySelector('.desc-input').focus();
            newRow.querySelectorAll('.qty, .price, .tax-rate-input').forEach(input => input.addEventListener('input', calculate));
            calculate();
        });

        // Zeile l√∂schen
        document.getElementById('invoice-items').addEventListener('click', e => {
            if (e.target.classList.contains('remove')) {
                e.target.closest('tr').remove();
                calculate();
            }
        });

        // PDF-Download
        document.getElementById('pdf-download').addEventListener('click', async () => {
            const element = document.getElementById('invoice-content');
            const canvas = await html2canvas(element, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const width = pdf.internal.pageSize.getWidth();
            const height = pdf.internal.pageSize.getHeight();
            pdf.addImage(imgData, 'PNG', 0, 0, width, height);
            pdf.save(`Rechnung_${document.getElementById('invoice-number').textContent || 'Entwurf'}.pdf`);
        });

        // Excel-Download
        document.getElementById('excel-download').addEventListener('click', () => {
            const wb = XLSX.utils.book_new();
            const data = [];
            data.push(["Rechnung", document.getElementById('invoice-number').textContent || 'Entwurf']);
            data.push(["Datum", document.getElementById('invoice-date').textContent]);
            data.push(["Kunde", document.getElementById('customer-info').innerText.split('\n')[0] || '']);
            data.push([]);
            data.push(["Beschreibung", "Menge", "Einzelpreis", "MwSt. (%)", "Gesamt"]);
            document.querySelectorAll('.item').forEach(row => {
                const desc = row.querySelector('input[type=text]').value;
                const qty = row.querySelector('.qty').value;
                const price = row.querySelector('.price').value;
                const tax = row.querySelector('.tax-rate-input').value;
                const total = row.querySelector('.line-total').textContent;
                data.push([desc, qty, price, tax, total]);
            });
            data.push([]);
            data.push(["Nettobetrag", document.getElementById('subtotal').textContent]);
            data.push(["Rabatt", document.getElementById('discount').value + " ‚Ç¨"]);
            data.push(["MwSt.", document.getElementById('tax').textContent]);
            data.push(["Gesamtbetrag", document.getElementById('grandtotal').textContent]);

            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Rechnung");
            XLSX.writeFile(wb, `Rechnung_${document.getElementById('invoice-number').textContent || 'Entwurf'}.xlsx`);
        });

        // E-Mail
        document.getElementById('email-send').addEventListener('click', () => {
            const customerEmail = document.getElementById('customer-email').value.trim() || '';
            const subject = encodeURIComponent(`Rechnung ${document.getElementById('invoice-number').textContent || 'Entwurf'} von H2TechService`);
            const body = encodeURIComponent(`Sehr geehrte Damen und Herren,\n\nanbei die Rechnung ${document.getElementById('invoice-number').textContent || 'Entwurf'} vom ${document.getElementById('invoice-date').textContent} √ºber ${document.getElementById('grandtotal').textContent}.\n\nVielen Dank!\n\nH2TechService`);
            window.location.href = `mailto:\( {customerEmail}?subject= \){subject}&body=${body}`;
        });

        // Drucken
        document.getElementById('print-button').addEventListener('click', () => {
            window.print();
        });

        // Rechnungsarchiv
        function saveCurrentInvoice() {
            const invoiceData = {
                number: document.getElementById('invoice-number').textContent,
                date: document.getElementById('invoice-date').textContent,
                customerName: document.getElementById('customer-name').value || 'Kein Kunde',
                grandtotal: document.getElementById('grandtotal').textContent,
                fullData: {
                    items: [],
                    discount: document.getElementById('discount').value,
                    customerDetails: {
                        name: document.getElementById('customer-name').value,
                        street: document.getElementById('customer-street').value,
                        city: document.getElementById('customer-city').value,
                        email: document.getElementById('customer-email').value
                    }
                }
            };
            document.querySelectorAll('.item').forEach(row => {
                invoiceData.fullData.items.push({
                    desc: row.querySelector('input[type=text]').value,
                    qty: row.querySelector('.qty').value,
                    price: row.querySelector('.price').value,
                    taxRate: row.querySelector('.tax-rate-input').value
                });
            });

            let archive = JSON.parse(localStorage.getItem('h2InvoiceArchive') || '[]');
            const existingIndex = archive.findIndex(inv => inv.number === invoiceData.number);
            if (existingIndex > -1) {
                archive[existingIndex] = invoiceData;
            } else {
                archive.push(invoiceData);
            }
            localStorage.setItem('h2InvoiceArchive', JSON.stringify(archive));
        }

        document.getElementById('save-invoice').addEventListener('click', () => {
            saveCurrentInvoice();
            alert('Rechnung gespeichert und im Archiv aktualisiert!');
        });

        function loadArchive() {
            const archive = JSON.parse(localStorage.getItem('h2InvoiceArchive') || '[]');
            const tbody = document.querySelector('#archive-table tbody');
            tbody.innerHTML = '';
            if (archive.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Noch keine Rechnungen gespeichert.</td></tr>';
                return;
            }
            archive.forEach((inv, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${inv.number}</strong></td>
                    <td>${inv.date}</td>
                    <td>${inv.customerName}</td>
                    <td>${inv.grandtotal}</td>
                    <td>
                        <button class="btn btn-sm btn-primary load-invoice" data-index="${index}">Laden</button>
                        <button class="btn btn-sm btn-danger delete-invoice" data-index="${index}">L√∂schen</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('show-archive').addEventListener('click', () => {
            loadArchive();
            const archiveModal = new bootstrap.Modal(document.getElementById('archive-modal'));
            archiveModal.show();
        });

        document.querySelector('#archive-table tbody').addEventListener('click', e => {
            if (e.target.classList.contains('load-invoice')) {
                const index = e.target.dataset.index;
                const archive = JSON.parse(localStorage.getItem('h2InvoiceArchive') || '[]');
                const inv = archive[index];
                if (inv && inv.fullData) {
                    const d = inv.fullData;
                    document.getElementById('discount').value = d.discount || '0.00';
                    document.getElementById('customer-name').value = d.customerDetails.name || '';
                    document.getElementById('customer-street').value = d.customerDetails.street || '';
                    document.getElementById('customer-city').value = d.customerDetails.city || '';
                    document.getElementById('customer-email').value = d.customerDetails.email || '';
                    setCurrentDate();
                    const tbody = document.getElementById('invoice-items');
                    tbody.innerHTML = '';
                    d.items.forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'item';
                        row.innerHTML = `
                            <td><input type="text" class="form-control border-0 desc-input" value="${item.desc || ''}"></td>
                            <td class="text-center"><input type="number" class="form-control text-center qty border-0" value="${item.qty || 1}"></td>
                            <td class="text-end"><input type="number" class="form-control text-end price border-0" value="${item.price || '0.00'}"></td>
                            <td class="text-center"><input type="number" class="form-control text-center tax-rate-input border-0" value="${item.taxRate || defaultTaxRate.value}"></td>
                            <td class="line-total text-end">0,00</td>
                            <td class="text-center"><button class="btn btn-sm btn-outline-danger remove">X</button></td>
                        `;
                        tbody.appendChild(row);
                        row.querySelectorAll('.qty, .price, .tax-rate-input').forEach(input => input.addEventListener('input', calculate));
                    });
                    calculate();
                    bootstrap.Modal.getInstance(document.getElementById('archive-modal')).hide();
                }
            } else if (e.target.classList.contains('delete-invoice')) {
                if (confirm('Rechnung l√∂schen?')) {
                    const index = e.target.dataset.index;
                    let archive = JSON.parse(localStorage.getItem('h2InvoiceArchive') || '[]');
                    archive.splice(index, 1);
                    localStorage.setItem('h2InvoiceArchive', JSON.stringify(archive));
                    loadArchive();
                }
            }
        });

        // Initialisierung
        setCurrentDate();
        calculate();
    </script>
</body>
</html>
