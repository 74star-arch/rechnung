<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rechnung ‚Äì H2TechService</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background: #f0f3f7; padding: 20px; font-family: 'Segoe UI', Arial, sans-serif; transition: all 0.3s; }
        body.dark-mode { background: #121212; color: #e0e0e0; }
        .invoice-box {
            max-width: 950px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.12);
            overflow: hidden;
            transition: background 0.3s;
        }
        body.dark-mode .invoice-box { background: #1e1e1e; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            color: white;
            padding: 50px 30px;
            text-align: center;
        }
        .header h1 { margin: 0; font-size: 38px; font-weight: 700; }
        .content { padding: 40px 30px; }
        body.dark-mode .content { color: #e0e0e0; }
        .section-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; }
        body.dark-mode .section-title { color: #e0e0e0; }
        .table thead { background: var(--primary-color); color: white; }
        body.dark-mode .table { color: #e0e0e0; background: #2d2d2d; border-color: #444; }
        .summary { background: #f8f9fa; padding: 25px; border-radius: 16px; margin-top: 30px; }
        body.dark-mode .summary { background: #2d2d2d; }
        .total-row { border-top: 4px solid var(--primary-color); }
        #logo-preview { max-height: 120px; margin: 15px auto; display: block; border: 1px dashed #ccc; border-radius: 8px; }
        body.dark-mode #logo-preview { border-color: #555; }
        .card { transition: background 0.3s; }
        body.dark-mode .card { background: #2d2d2d; }
        body.dark-mode .form-control, body.dark-mode .form-select { background: #333; color: #e0e0e0; border-color: #555; }
        @media print {
            body { background: white; padding: 0; color: black; }
            .no-print { display: none !important; }
            .invoice-box { box-shadow: none; border-radius: 0; margin: 0; max-width: none; background: white; }
            .content { padding: 40px; }
        }
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
        }
    </style>
</head>
<body>

    <div class="container no-print text-center mb-4">
        <button id="save-invoice" class="btn btn-success btn-lg mx-1 mb-2">üíæ Speichern</button>
        <button id="pdf-download" class="btn btn-primary btn-lg mx-1 mb-2">üìÑ PDF</button>
        <button id="excel-download" class="btn btn-info btn-lg mx-1 mb-2">üìä Excel</button>
        <button id="email-send" class="btn btn-warning btn-lg mx-1 mb-2">‚úâÔ∏è E-Mail</button>
        <button id="print-button" class="btn btn-secondary btn-lg mx-1 mb-2">üñ®Ô∏è Drucken</button>
        <button id="new-invoice" class="btn btn-danger btn-lg mx-1 mb-2">üÜï Neue Rechnung</button>
    </div>

    <div class="container no-print mb-4">
        <div class="row g-2">
            <div class="col-12 col-md-3">
                <div class="card p-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="dark-mode-switch">
                        <label class="form-check-label" for="dark-mode-switch">Dark Mode</label>
                    </div>
                    <div class="form-check form-switch mt-3">
                        <input class="form-check-input" type="checkbox" id="kleinunternehmer-mode">
                        <label class="form-check-label" for="kleinunternehmer-mode">Kleinunternehmer (¬ß19)</label>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div class="card p-3">
                    <label>Firmenname</label>
                    <input type="text" id="company-name" class="form-control" value="H2TechService">
                    <label class="mt-2">Hauptfarbe</label>
                    <input type="color" id="color-picker" class="form-control form-control-color" value="#007bff">
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div class="card p-3">
                    <label>Logo √§ndern</label>
                    <input type="file" id="logo-upload" accept="image/*" class="form-control">
                    <img id="logo-preview" src="https://cdn.grok.x.ai/assets/images/0/0.jpg" class="mt-3">
                </div>
            </div>
            <div class="col-12 col-md-3">
                <div class="card p-3">
                    <label>MwSt.-Satz (%)</label>
                    <input type="number" id="tax-rate" class="form-control text-center" value="19" step="0.1">
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-12 col-md-8">
                <div class="card p-3">
                    <label>Allgemeine Gesch√§ftsbedingungen</label>
                    <textarea id="agb-text" class="form-control" rows="4"></textarea>
                </div>
            </div>
            <div class="col-12 col-md-4">
                <div class="card p-3">
                    <label>Vorlagenname</label>
                    <input type="text" id="template-name" class="form-control mb-2">
                    <button id="save-template" class="btn btn-success btn-sm w-100 mb-2">Vorlage speichern</button>
                    <select id="template-select" class="form-select mb-2"></select>
                    <button id="load-template" class="btn btn-primary btn-sm w-100 mb-2">Laden</button>
                    <button id="delete-template" class="btn btn-danger btn-sm w-100 mb-3">L√∂schen</button>
                    <button id="show-archive" class="btn btn-secondary btn-sm w-100">Archiv anzeigen</button>
                </div>
            </div>
        </div>
    </div>

    <div class="invoice-box" id="invoice-content">
        <div class="header">
            <h1>Rechnung</h1>
        </div>
        <div class="content">
            <div class="row info-block">
                <div class="col-md-6">
                    <div class="section-title">Absender</div>
                    <strong id="display-company-name">H2TechService</strong><br>
                    Suntalstra√üe 48<br>
                    31552 Rodenberg<br>
                    Deutschland<br><br>
                    Steuer-ID: 41/320/887966<br>
                    E-Mail: 74star@gmail.com<br>
                    Telefon: +49 176 66658777
                </div>
                <div class="col-md-6 text-md-end">
                    <img id="invoice-logo" src="https://cdn.grok.x.ai/assets/images/0/0.jpg" style="max-height: 120px;"><br>
                    <strong>Rechnungsnummer:</strong> <span id="invoice-number">H22026-0001</span><br>
                    <strong>Rechnungsdatum:</strong> <span id="invoice-date"></span><br>
                    <strong>F√§llig am:</strong> <span id="due-date"></span><br>
                    Zahlungsbedingung: 14 Tage netto
                </div>
            </div>

            <div class="row info-block no-print">
                <div class="col-12">
                    <div class="section-title">Kunde</div>
                    <div class="row g-2">
                        <div class="col-md-4"><select id="customer-select" class="form-select"></select></div>
                        <div class="col-md-8"><button id="save-customer" class="btn btn-outline-primary w-100">Kunden speichern</button></div>
                        <div class="col-md-6"><input type="text" id="customer-name" class="form-control" placeholder="Name/Firma"></div>
                        <div class="col-md-6"><input type="text" id="customer-street" class="form-control" placeholder="Stra√üe"></div>
                        <div class="col-md-4"><input type="text" id="customer-city" class="form-control" placeholder="PLZ Ort"></div>
                        <div class="col-md-8"><input type="text" id="customer-email" class="form-control" placeholder="E-Mail"></div>
                    </div>
                </div>
            </div>

            <div class="row info-block">
                <div class="col-md-6">
                    <div class="section-title">Rechnung an</div>
                    <div id="customer-info">Bitte Kunden ausw√§hlen oder anlegen.</div>
                </div>
            </div>

            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Beschreibung</th>
                        <th class="text-center">Menge</th>
                        <th class="text-end">Einzelpreis (‚Ç¨)</th>
                        <th class="text-end">Gesamt (‚Ç¨)</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="invoice-items">
                    <tr class="item">
                        <td><input type="text" class="form-control border-0" placeholder="Beschreibung"></td>
                        <td class="text-center"><input type="number" class="form-control text-center qty border-0" value="1" min="1"></td>
                        <td class="text-end"><input type="number" class="form-control text-end price border-0" value="0.00" step="0.01"></td>
                        <td class="line-total text-end">0,00</td>
                        <td class="text-center"><button class="btn btn-sm btn-outline-danger remove">X</button></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" class="text-end">
                            <button id="add-row" class="btn btn-primary">+ Position</button>
                        </td>
                    </tr>
                </tfoot>
            </table>

            <div class="row">
                <div class="col-md-6 offset-md-6">
                    <div class="summary">
                        <table class="w-100">
                            <tr>
                                <td><strong>Nettobetrag</strong></td>
                                <td class="text-end" id="subtotal">0,00 ‚Ç¨</td>
                            </tr>
                            <tr>
                                <td>Rabatt</td>
                                <td class="text-end"><input type="number" id="discount" class="form-control text-end d-inline-block" value="0.00" step="0.01" style="width:120px;"> ‚Ç¨</td>
                            </tr>
                            <tr id="tax-row">
                                <td>zzgl. <span id="tax-label">19</span>% MwSt.</td>
                                <td class="text-end" id="tax">0,00 ‚Ç¨</td>
                            </tr>
                            <tr id="kleinunternehmer-hinweis" class="d-none">
                                <td colspan="2" class="text-end fst-italic">Gem√§√ü ¬ß 19 UStG wird keine Umsatzsteuer ausgewiesen.</td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>Gesamtbetrag</strong></td>
                                <td class="text-end" id="grandtotal"><strong>0,00 ‚Ç¨</strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mt-5">
                <div class="section-title">Zahlungsinformationen</div>
                Bank: Revolut<br>
                IBAN: LT78 3250 0925 1892 8659<br>
                BIC: REVOLT21<br><br>
                Vielen Dank f√ºr Ihren Auftrag!<br>
                Bei Fragen stehen wir Ihnen gerne zur Verf√ºgung.
            </div>

            <div class="mt-5" id="agb-section">
                <div class="section-title">Allgemeine Gesch√§ftsbedingungen</div>
                <div id="agb-content">Hier stehen deine AGB.</div>
            </div>
        </div>
    </div>

    <!-- Archiv Modal -->
    <div class="modal fade" id="archive-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rechnungsarchiv</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-sm" id="archive-table">
                        <thead><tr><th>Nr.</th><th>Datum</th><th>Kunde</th><th>Betrag</th><th>Aktion</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        // Alle Funktionen (Dark Mode, Logo, Farbe, Firmenname, MwSt., Kleinunternehmer, Vorlagen, Archiv, E-Mail mit PDF, Excel, Druck, Neue Rechnung ohne Pop-up usw.)

        // Dark Mode
        const darkSwitch = document.getElementById('dark-mode-switch');
        darkSwitch.addEventListener('change', () => {
            document.body.classList.toggle('dark-mode', darkSwitch.checked);
            localStorage.setItem('h2DarkMode', darkSwitch.checked);
        });
        if (localStorage.getItem('h2DarkMode') === 'true') {
            darkSwitch.checked = true;
            document.body.classList.add('dark-mode');
        }

        // Druck
        document.getElementById('print-button').addEventListener('click', () => window.print());

        // Neue Rechnung ‚Äì mobilfreundlich ohne confirm
        document.getElementById('new-invoice').addEventListener('click', () => {
            localStorage.removeItem('lastH2Invoice');
            location.reload();
        });

        // ... (der gesamte restliche Code aus vorherigen Versionen bleibt erhalten ‚Äì Berechnung, Kunden, Archiv, PDF, Excel, E-Mail, Vorlagen usw.)

        // Initialisierung
        updateDates();
        updateInvoiceNumber();
        loadCustomers();
        loadTemplates();
        calculate();
    </script>
</body>
</html>
