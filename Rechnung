<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rechnung – H2TechService</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background: #f0f3f7; padding: 20px; font-family: 'Segoe UI', Arial, sans-serif; transition: all 0.3s; }
        body.dark-mode { background: #121212; color: #e0e0e0; }
        .invoice-box {
            max-width: 950px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.12);
            overflow: hidden;
            transition: background 0.3s;
        }
        body.dark-mode .invoice-box { background: #1e1e1e; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            color: white;
            padding: 50px 30px;
            text-align: center;
        }
        .header h1 { margin: 0; font-size: 38px; font-weight: 700; }
        .content { padding: 40px 30px; }
        body.dark-mode .content { color: #e0e0e0; }
        .section-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; }
        body.dark-mode .section-title { color: #e0e0e0; }
        .table thead { background: var(--primary-color); color: white; }
        body.dark-mode .table { color: #e0e0e0; background: #2d2d2d; border-color: #444; }
        .summary { background: #f8f9fa; padding: 25px; border-radius: 16px; margin-top: 30px; }
        body.dark-mode .summary { background: #2d2d2d; }
        .total-row { border-top: 4px solid var(--primary-color); }
        #logo-preview { max-height: 120px; margin: 15px auto; display: block; border: 1px dashed #ccc; border-radius: 8px; }
        body.dark-mode #logo-preview { border-color: #555; }
        .card { transition: background 0.3s; }
        body.dark-mode .card { background: #2d2d2d; }
        body.dark-mode .form-control, body.dark-mode .form-select { background: #333; color: #e0e0e0; border-color: #555; }
        @media print {
            body { background: white; padding: 0; color: black; }
            .no-print { display: none !important; }
            .invoice-box { box-shadow: none; border-radius: 0; margin: 0; max-width: none; background: white; }
            .content { padding: 40px; }
        }
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
        }
    </style>
</head>
<body>

    <!-- Buttons und Einstellungen wie zuvor -->

    <div class="invoice-box" id="invoice-content">
        <!-- Rechnungs-Layout wie zuvor -->

        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Beschreibung</th>
                    <th class="text-center">Menge</th>
                    <th class="text-end">Einzelpreis (€)</th>
                    <th class="text-end">Gesamt (€)</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="invoice-items">
                <tr class="item">
                    <td><input type="text" class="form-control border-0" placeholder="Beschreibung"></td>
                    <td class="text-center"><input type="number" class="form-control text-center qty border-0" value="1" min="1"></td>
                    <td class="text-end"><input type="number" class="form-control text-end price border-0" value="0.00" step="0.01"></td>
                    <td class="line-total text-end">0,00</td>
                    <td class="text-center"><button class="btn btn-sm btn-outline-danger remove">X</button></td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="5" class="text-end">
                        <button id="add-row" class="btn btn-primary">+ Position</button>
                    </td>
                </tr>
            </tfoot>
        </table>

        <!-- Zusammenfassung wie zuvor -->
    </div>

    <script>
        // Automatische Berechnung – verbessert
        function calculate() {
            let subtotal = 0;
            document.querySelectorAll('.item').forEach(row => {
                const qty = parseFloat(row.querySelector('.qty').value) || 0;
                const price = parseFloat(row.querySelector('.price').value) || 0;
                const total = qty * price;
                row.querySelector('.line-total').textContent = total.toFixed(2).replace('.', ',');
                subtotal += total;
            });

            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const taxable = subtotal - discount;
            const taxRate = parseFloat(document.getElementById('tax-rate').value) / 100 || 0.19;
            const tax = taxable * taxRate;
            const grand = taxable + tax;

            document.getElementById('subtotal').textContent = subtotal.toFixed(2).replace('.', ',') + ' €';
            document.getElementById('tax').textContent = tax.toFixed(2).replace('.', ',') + ' €';
            document.getElementById('grandtotal').innerHTML = '<strong>' + grand.toFixed(2).replace('.', ',') + ' €</strong>';
        }

        // Bei jeder Eingabe in Menge oder Preis sofort rechnen
        document.getElementById('invoice-items').addEventListener('input', e => {
            if (e.target.classList.contains('qty') || e.target.classList.contains('price')) {
                calculate();
            }
        });

        document.getElementById('discount').addEventListener('input', calculate);
        document.getElementById('tax-rate').addEventListener('input', calculate);

        // Neue Zeile hinzufügen – mit automatischer Berechnung
        document.getElementById('add-row').addEventListener('click', () => {
            const tbody = document.getElementById('invoice-items');
            const newRow = document.createElement('tr');
            newRow.className = 'item';
            newRow.innerHTML = `
                <td><input type="text" class="form-control border-0" placeholder="Beschreibung"></td>
                <td class="text-center"><input type="number" class="form-control text-center qty border-0" value="1" min="1"></td>
                <td class="text-end"><input type="number" class="form-control text-end price border-0" value="0.00" step="0.01"></td>
                <td class="line-total text-end">0,00</td>
                <td class="text-center"><button class="btn btn-sm btn-outline-danger remove">X</button></td>
            `;
            tbody.appendChild(newRow);
            // Neue Eingabefelder auch mit Berechnung verknüpfen
            newRow.querySelectorAll('.qty, .price').forEach(input => input.addEventListener('input', calculate));
            calculate();
        });

        // Zeile löschen
        document.getElementById('invoice-items').addEventListener('click', e => {
            if (e.target.classList.contains('remove')) {
                e.target.closest('tr').remove();
                calculate();
            }
        });

        // Initiale Berechnung
        calculate();

        // Dein Logo fest eingebaut
        document.getElementById('logo-preview').src = 'https://cdn.grok.x.ai/assets/images/1/1.jpg';
        document.getElementById('invoice-logo').src = 'https://cdn.grok.x.ai/assets/images/1/1.jpg';

        // Alle anderen Funktionen (Speichern, PDF, E-Mail, Neue Rechnung ohne Pop-up, etc.) bleiben wie zuvor
    </script>
</body>
</html>
